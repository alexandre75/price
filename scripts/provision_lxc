#!/bin/bash -x

file=$1
name=$(basename $1)
env=$2

# infra
sudo systemctl start mongodb
sudo lxc launch images:9d00c7547946 price
PUBLIC_IP=192.168.45.225
CONTAINER_IP=$(sudo lxc info price | grep eth0 | grep -w inet | cut -f3)

line_number=`sudo iptables -t nat -L --line-numbers | grep ${PUBLIC_IP}:8080 | awk '{print $1}'`
sudo iptables -t nat -D PREROUTING $line_number

sudo iptables -t nat -I PREROUTING -i eth0 -p TCP -d $PUBLIC_IP --dport $PORT -j DNAT --to-destination $CONTAINER_IP:8080 -m comment --comment "forward to the Nginx container"


# package
sudo lxc file push $file price/tmp/
sudo lxc file push ./conf/application.properties.$env price/etc/price/application.properties
#sudo lxc exec price -- echo "CONF_FOLDER=/etc/price" > /usr/lib/price/${name%jar}conf
sudo lxc exec price -- apt-get install -yf /tmp/$name
sudo lxc exec price -- systemctl daemon-reload

#config
sudo lxc file push ./conf/application.properties.$env price/usr/lib/price/application.properties

sudo lxc exec price -- systemctl start price
